<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功夫量化</title>
    <meta name="theme-color" content="#e9ecef">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        html,
        body {
            background-color: var(--bs-gray-200);
        }

        .notes-header {
            background-color: #fff;
        }

        .notes-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 92px;
        }

        a {
            color: var(--bs-body-color);
            text-decoration: none;
        }

        a:hover {
            transition: all .2s;
            color: var(--bs-blue);
        }

        .footer {
            text-align: center;
            padding: 2em 0 2em;
            font-size: .9rem;
        }

        .release-item {
            display: flex;
            align-items: center;
            padding: 1em;
            flex-wrap: nowrap;
        }

        .release-item-left {
            flex: 1;
            font-weight: 600;
            padding-right: 2em;
        }

        .core-link {
            margin: 0 2em;
            text-align: center;
        }
    </style>
</head>

<body>
    <header class="notes-header">
        <div class="container">
            <img width="300" height="61"
                src="https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网-300x61.png"
                class="custom-logo" alt="功夫量化" decoding="async"
                srcset="https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网-300x61.png 300w, https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网-1024x208.png 1024w, https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网-768x156.png 768w, https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网-1536x312.png 1536w, https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网-600x122.png 600w, https://s3.cn-northwest-1.amazonaws.com.cn/users.kungfu-trader.com/uploads/2022/12/cropped-功夫量化图标-官网.png 1983w"
                sizes="(max-width: 300px) 100vw, 300px">
            <div>
                <a href="https://www.kungfu-trader.com/" target="_blank" style="font-size: 1.2rem;">Website</a>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="card" style="width: 100%; margin-top: 2em;">
            <div class="card-body">
                <h3>kungfu-trader</h3>
                <p class="card-text">Kungfu Trader is a trading platform for quantitative trading.</p>
                <div style="margin-left: -0.5em;">
                    <a href="https://releases.kungfu-trader.com/kungfu-trader/release-stable.html" target="_blank"
                        class="btn btn-primary" style="margin: .5em">Check
                        kungfu-trader Releases</a>
                    <a href="https://releases.kungfu-trader.com/artifact-kungfu/release-stable.html" target="_blank"
                        class="btn btn-primary" style="margin: .5em">Check
                        artifact-kungfu Releases</a>
                </div>
            </div>
        </div>
        <h4 style="margin-top: 1em;">stables</h4>
        <div class="list-group" style="margin-top: 1.2em;" id="stables-list"></div>
        <h4 style="margin-top: 2em;">prereleases</h4>
        <div class="list-group" style="margin-top: 1.2em;" id="prereleases-list"></div>
    </div>
    <footer class="footer">
        版权所有 © 北京功夫源科技发展有限责任公司 |
        <a rel="external" title="备案号" class="link" href="http://beian.miit.gov.cn">京ICP备19056728号-1</a>
    </footer>
    <script>
        const baseUrl = "https://releases.kungfu-trader.com/";
        const baseRepo = "kungfu-trader";

        window.onload = function () {
            fetch('https://releases.kungfu-trader.com/kungfu-trader/metadata.txt')
                .then(res => res.text())
                .then(res => {
                    const { stables, prereleases } = formatMetadata(res);
                    const stablesFragment = stables.reduce((acc, cur) => acc + generateItem(cur), '');
                    const prereleasesFragment = prereleases.reduce(
                        (acc, cur) => acc + cur.items.reduce((accx, curx) => accx + generateItem(curx), ''),
                        '');
                    document.getElementById('stables-list').innerHTML = stablesFragment;
                    document.getElementById('prereleases-list').innerHTML = prereleasesFragment;
                })
                .then(() => {
                    document.querySelectorAll('.core-link').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            location.href = item.getAttribute('data-href');
                        })
                    });
                })
                .catch(e => console.error(e))
        }

        const generateItem = (obj) => {
            return `
                <a href="${obj.url}"
                    class="list-group-item list-group-item-action" aria-current="true">
                    <div class="release-item">
                        <div class="release-item-left">${obj.version}</div>
                        <div class="release-item-right">
                            <div data-href="${obj.coreUrl}" class="core-link">
                                <span>kungfu-core</span>
                                <span class="badge rounded-pill bg-primary">${obj.coreVersion}</span>
                            </div>
                        </div>
                    </div>
                </a>
            `
        };
        const formatMetadata = (text) => {
            const metadata = text.split('\n').filter(v => !!v).map(v => {
                const target = JSON.parse(v)
                const version = encodeURI(target.version);
                const coreVersion = encodeURI((target.coreVersion || target.dependencies)["@kungfu-trader/kungfu-core"]);
                return {
                    version,
                    coreVersion,
                    url: `${baseUrl}${baseRepo}/${getCurrentVersion(version)}/index.html`,
                    coreUrl: `${baseUrl}artifact-kungfu/${getCurrentVersion(
                        "v" + coreVersion
                    )}/index.html`,
                };
            });
            return {
                stables: _.sortBy(
                    metadata.filter((v) => !v.version.includes("-alpha")),
                    (v) => getWeightingNumber(v.version.slice(1), metadata.length)
                ),
                prereleases: groupItems(
                    metadata.filter((v) => v.version.includes("-alpha")),
                    (v) => v.version.replace(/-alpha.\d+/, "")
                ),
            }
        }

        const getCurrentVersion = (version) => {
            return `${version.split(".")[0]}/${version}`;
        };

        const getWeightingNumber = (name, len) => {
            const [v1, v2, v3, v4] = name.replace("-alpha", "").split(".");
            if (v4) {
                return (v4 === "html" ? len : +v4) * -1;
            }
            return (v1 * len * 100 + v2 * len + +v3) * -1;
        };

        const groupItems = (items, hander) => {
            const result = items.reduce((acc, cur) => {
                const key = hander(cur);
                const target = acc.find((v) => v.key === key);
                target
                    ? target.items.push(cur)
                    : acc.push({
                        key,
                        items: [cur],
                    });
                return acc;
            }, []);
            result.forEach(
                (e) =>
                (e.items = _.sortBy(e.items, (v) =>
                    getWeightingNumber(v.version.slice(1), e.items.length)
                ))
            );
            return _.sortBy(result, (v) =>
                getWeightingNumber(v.key.slice(1), result.length)
            );
        };
    </script>
</body>

</html>